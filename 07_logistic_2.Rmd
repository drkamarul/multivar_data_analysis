
# Logistic Regression

## Introduction

We will be using examples from <http://ftp.auckland.ac.nz/software/CRAN/doc/vignettes/HSAUR/Ch_logistic_regression_glm.pdf>

We will use 5 packages

1.  the built in **stat** package - to run Generalized Linear Model. it is already loaded
2.  **HSAUR** package - to use the `fatal` dataset as an example. 
3.  **tidyverse** package - for data transformation 
4.  **broom** package - to tidy up the results 
4.  **LogisticDx** package - to do model assessment


```{r}
library(tidyverse)
library(broom)
library(HSAUR)
library(LogisticDx)
library(here)
```

## Data

We will use a dataset named **stroke_dta**.

Call data into R

```{r}
fatal <- read_csv(here('data','stroke_data.csv'))
```

Take a peek at data

```{r}
glimpse(fatal)
```

Get summary statistics

```{r}
summary(fatal)
```

The **fatal** data contain status as  the dependent variable. It is a binary variable but classed as a character variable.

```{r}
str(fatal$status)
```

We can convert the character variable to a factor (categorical) variable. But we notice that dead comes after alive. This will cause problem in interpretation later. Assuming, we want the 'worse' category as the reference, then we need to make alive as the first category.  

```{r}
fatal <- fatal %>% mutate(status2 = fct_relevel(status, "alive", "dead")) 
glimpse(fatal)
str(fatal$status2)
```


Verify that status is a factor (categorical variable) with

- $dead$ is coded as 2
- $alive$ is coded as 1


## Estimation

Objective: To estimate the regression parameters $\hat\beta_s$

Two approaches:

1.  Univariable = 1 independent variable (covariate)
2.  Multivariable = 2 or more independent variable (covariates)

## Univariable analysis 

One dependent variable with one independent (predictor) variable.

1.  The dependent variable is ESR, a binary variable.
2.  The predictor is a numerical (continouos) variable 

We first estimate the log odds (the regression parameters, $\beta$). 

$$log\frac{Pr(ESR = high)}{1 - Pr(ESR = high)}  = \beta_0 + \beta_1(gcs)$$

Estimate the parameter

```{r}
fatal_glm_1 <- glm(status2 ~ gcs, data = fatal, 
                    family = binomial(link = 'logit'))
```

Get the summarized result of the model

```{r}
summary(fatal_glm_1)
```

Cleaner result in data frame format

```{r}
tidy(fatal_glm_1, conf.int = TRUE)
```



```{r}
fatal_glm_2 <- glm(status2 ~ str_type2, data = fatal, 
                    family = binomial(link = 'logit'))
tidy(fatal_glm_2)
```

## Multivariable analysis

Unlikely only one variable (gcs) relates with stroke. Consider adding other seemingly important independent variable for example stroke type. To do that, we will add **str_type2** to the model

Estimate the model

```{r}
fatal_mv <- glm(status2 ~ gcs + str_type2, data = fatal,
                    family = binomial(link = 'logit'))
```

Summary of estimates

```{r}
summary(fatal_mv)
```

Cleaner result in data frame format

```{r}
result_mv <- tidy(fatal_mv, conf.int = TRUE)
result_mv
```


## Estimate the Odds Ratio

For lay person, it is difficult to interpret the log odds. It is easier to interpret - for lay person - the model using the odds ratio. 

This can be done by $\exp^{\beta_i}$

```{r}
or_gcs <- exp(fatal_glm_1$coefficients)
or_gcs
```

We do not generally interpret $\hat\beta_0$. In the model, it means that if **gcs** increases by 1 unit, the odds to be dead change by `r or_gcs[2]`times.  

In multivariable model, the adjusted odds ratio are

```{r}
or_mv <- exp(fatal_mv$coefficients)
or_mv <- round(or_mv, digits = 4)
or_mv
```

Let us combine the results

```{r}
bind_cols(result_mv, adj_or = or_mv)
```

In the model, it means that if **gcs** increases by 1 unit (when *stroke type* is adjusted), the odds to be in the fatal group, change to 0.71 or $29\%$ reduction. 

## Inference 

Let us examine the inferences of the model. 

This involves:

1.  checking the p-values
2.  getting the 95% confidence intervals (CI)

For the univariable model (model 1), the 95% CI for the log odds are:

```{r}
confint(fatal_glm_1)
```

Interpretation: 

With 1 unit increase in gcs, the log odds to have died can be as small as $-0.34$ and as big as $-0.29$ at $95\%$ confidence level. 

For the multivariable model (model 2), the $95\%$ CI for the adjusted log odds are:

```{r}
ci_mv <- confint(fatal_mv)
ci_mv
```

or using `tidy()`

```{r}
result_mv
```


The results shows:

1.  that with 1 unit increase in gcs (while adjusting for stroke type), the log odds for fatality ranges from `r result_mv[2,6]` to  `r result_mv[2,7]` at $95\%$ CI 
2.  that for patients with IS (while adjusting for gcs), the log odds for fatality ranges from `r result_mv[3,6]` to  `r result_mv[3,7]` at $95\%$ CI

Combine the results

```{r}
result_mv %>% mutate(adj_or = exp(estimate),
                     low_or = exp(conf.low),
                     high_or = exp(conf.high))
```


## Model comparison

Is there any difference between model 1 and model 2 at level of significance of $5\%$?

```{r}
anova(fatal_mv, fatal_glm_1, test = 'Chisq')
```



## Inference using OR

For univariable model, to estimate the odds ratio 

```{r}
exp(confint(fatal_glm_1))
```

For multivariable model, to estimate the odds ratios

```{r}
ci_or_mv <- exp(confint(fatal_glm_2))
ci_or_mv <- round(ci_or_mv, digits = 3)
ci_or_mv
```


## Prediction 

We used `broom::augment()` to calculate the

1.  log odds and probability
2.  residuals
3.  hat values
4.  Cooks distance
5.  standardized residuals

## Predict the log odds

the .fitted column represents the estimated log odds for each row

```{r}
augment(fatal_mv)
```

## Predict the probability

the .fitted column represents the estimated probability for each row


```{r}
augment(fatal_mv, type.predict = "response")
```

## Model fitness

```{r}
library(LogisticDx)
fit_m <- gof(fatal_mv, g = 7)
fit_m$gof
```



